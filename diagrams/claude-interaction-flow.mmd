flowchart TD
    subgraph "Подготовка запроса"
        A[Получение данных из БД] --> B[Формирование контекста]
        B --> C[Выбор шаблона запроса]
        C --> D[Заполнение шаблона данными]
        D --> E[Финализация промпта]
    end
    
    subgraph "Взаимодействие с API Claude"
        E --> F[Отправка запроса в Claude API]
        F --> G{Удачный ответ?}
        G -- Да --> H[Обработка ответа]
        G -- Нет --> I[Повторная попытка/Fallback]
        I -.-> F
    end
    
    subgraph "Обработка и сохранение"
        H --> J[Извлечение структурированных данных]
        H --> K[Логирование взаимодействия]
        J --> L[Сохранение результатов в БД]
        K --> M[Обновление метрик использования]
    end
    
    subgraph "Кэширование и оптимизация"
        N[Проверка кэша] -.-> A
        L --> O[Обновление кэша]
        O -.-> N
    end
